# MySQL

### Table of Contents
* [`Description`](#description): What the module does and why it is useful.
* [`Setup`](#setup): The basics of getting started with MySQL.
  * [`Beginning`](#beginning-with-mysql): How to begin with MySQL using this module.
* [`Usage`](#usage): Configuration options and additional functionality.
  * [`MySQL Replication setup`](#mysql-replication-setup): Setup a master / slave replication setup.
  * [`MySQL databases`](#create-and-manage-databases): Create and manage databases.
  * [`MySQL users`](#create-and-manage-users): Create and manage users.
* [`Reference`](#reference): Peek under the hood.
* [`Limitations`](#limitations): OS compatibility and other limitations
* [`Development`](#development): When you want to contribute to this module.
  * [`TODO`](#todo): List of things and ideas left to do.

## Description
This module installs, configures and manages the MySQL database server. It is also possible to manage
databases and MySQL users through this module.

While Puppet Labs created a beautiful MySQL module, we wanted to create one ourselves from scratch.
Building this module from scratch thought as a lot about coding in Puppet and was an interesting
challenge in multiple ways. Now the first release candidate is ready we of course want to share
this with the rest of the world!

## Setup
Necessary setup steps that will help you start with this module are found underneath.

### Beginning with MySQL
In order to install a basic MySQL server with default settings:
```puppet
class{mysql:
    root_password => 'SomeRandomPassword'
}
```
See [`Reference`](#reference) for all of the available parameters and options.

## Usage
Most options and use cases can be found by reading the options given by our [`Reference`](#reference).

Some of the options however are a bit more complex or extensive. The examples for these use cases
are given underneath.

### MySQL replication setup
In order to setup a MySQL master server:
```puppet
class{mysql:
    root_password  => 'ExamplePassword',
    server_type    => 'master',
    server_id      => 10',
    log_expiration => 3,
    binlog_size    => '100M',
    replicate_db   => 'example_db',
    log_bin        => '/var/log/mysql/mysql-bin.log'
}
```

In order to setup a MySQL slave server:
```puppet
class{mysql:
    root_password  => 'ExamplePassword',
    server_type    => 'slave',
    server_id      => 11',
    log_expiration => 3,
    binlog_size    => '100M',
    replicate_db   => 'example_db'
}
```

### Create and manage databases
In order to create 'database_one' and delete 'database_two': 
```puppet
$databases = {'db_one' => 'present',
              'db_two' => 'absent'}
class{mysql:
    root_password => 'ExamplePassword',
    databases     => $databases
}
```

### Create and manage users
In order to create 'user_one', delete 'user_two@127.0.0.1' and delete 'user_three':
```puppet
$users = [{'name'          => 'user_one',
           'ensure'        => 'present',
           'password'      => '*410D6378736A5D19278BF9A7391B03A68950BB19',
           'password_type' => 'hash',
           'hosts'         => {'127.0.0.1' => 'present'},
           'permissions'   => {'*' => 'read_write'}},
          {'name'          => 'user_two',
           'ensure'        => 'present',
           'password'      => '*410D6378736A5D19278BF9A7391B03A68950BB19',
           'password_type' => 'hash',
           'hosts'         => {'127.0.0.1'   => 'absent',
                               'example.lan' => 'present'},
           'permissions'   => {'db_one' => 'read_only'}},
          {'name'          => 'user_three',
           'ensure'        => 'absent',
           'password'      => 'ExamplePassword',
           'password_type' => 'plain_text',
           'hosts'         => {'127.0.0.1' => 'present'},
           'permissions'   => {'*' => 'full'}}]

class{mysql:
    root_password => 'ExamplePassword',
    users         => $users
}
```


## Reference
For a full overview of all of the available paramaters, classes, defined types and everything else: see
the REFERENCE.md file, which is generated by Puppet Strings.

The only exception are custom facts and some more 'complex' parameters, which you will find underneath:

### Custom fact: mysql_current_root_password
We have created a custom fact for adding the current MySQL root password to the known facts
of the Puppet Agent node. This is necessary for being able to update the root password
through the parameter 'root_password'.

`$current_root_password = facts['mysql_current_root_password']`

Returns: `String` Either the current root password from file or an empty string if
the file can not be found or read.

### Parameter: `databases`
Data type: `Optional[Hash]`

Contains databases to manage through puppet.

This hash expects the database name as the key and the database state (could be 'present' or 'absent') as the value:

```puppet
$databases = {'db_one' => 'present',
              'db_two' => 'absent'}
```

### Parameter: `users`
Data type: `Optional[Array]`

Contains users to manage through puppet.

This array expects one or more user objects. Every user object is a `hash` containing the following keys:
* name `String`: the name of the user.
* ensure `String`: the state of the user, should be either 'present' or 'absent'.
* password `String`: the password of the user, can be in plain text or in a MySQL password hash.
* password_type `String`: Should be either 'plain_text' or 'hash'.
* hosts `Hash`: A hash containing 'hostnames' as the keys and their state ('present' or 'absent') as values.
* permissions `Hash`: A hash containing database names as the keys and the role of the user as values.

An overview of the user roles and their permissions is listed underneath:
* read_only:
  * select
* read_write:
  * select
  * insert
  * update
  * delete
  * create
  * drop
  * index
  * alter
* read_write_extended:
  * select
  * insert
  * update
  * delete
  * create
  * drop
  * index
  * alter
  * create_tmp_table
  * lock_tables
  * execute
  * create_view
  * show_view
  * create_routine
  * alter_routine
  * event
  * trigger
* slave:
  * slave
* none
  * ensures that every permission is set to 'N'
* full
  * ensures that every permission is set to 'Y'

When an asterisk (\*) is used instead of a database name the user will be granted global privileges instead of database specific.

An example user could be made like this:
```puppet
$users = [{'name'          => 'user_one',
           'ensure'        => 'present',
           'password'      => '*410D6378736A5D19278BF9A7391B03A68950BB19',
           'password_type' => 'hash',
           'hosts'         => {'127.0.0.1' => 'present'},
           'permissions'   => {'*' => 'read_write'}}]
```
**Note:** Do not try to manage the 'root' user through this parameter. This is done by the root_user.pp class.

## Limitations
This module has been tested on:
* Ubuntu 16.04
* Ubuntu 18.04

Testing on other platforms has not been done yet.

## Development
This project has been released under the Apache License 2.0 and is considered open software.
Everyone is permitted to make changes as long as the above license is followed.

See [our guidelines](https://wiki.itsburning.nl/puppet:guide_lines) to learn
about what guidelines to follow.

### TODO
#### Sort parameters
The parameters currently are not in alphabetically order. This should be changed, so that the order still has required parameters before optional ones, but parameters from the same type should be alphabetically ordered.

#### Decide on 'secure_install' optional parts
The current secure_install class executes a couple of steps, which could be made optional.
Maybe create new parameters to do so.

#### Create custom database and user types
By extending Puppet we can create our own types and providers in Ruby. This gives us the possibility to
remove a whole load of the EXEC's that has been created and create cleaner / better code.
We will do this in a future release.
